<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Privacy Analysis Results</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #333; }
        .risk-summary-box {
            /* Existing styles, perhaps adjust background if using -bg classes */
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            border: 1px solid #ccc; /* Default border */
        }
        .risk-summary-box h3 {
            margin-top: 0;
            text-align: center;
        }
        .risk-score-value {
            font-weight: bold;
            font-size: 1.8em; /* Larger font for the score */
        }
        .risk-category-label {
           font-weight: bold;
           font-size: 1.2em;
           text-align: center;
           margin-bottom: 10px;
        }
        .risk-hr { margin-top: 10px; margin-bottom: 10px; border-style: dashed; border-color: #ccc; }

        /* Backgrounds for the box */
        .risk-score-low-bg { background-color: #e6ffed; border-left: 5px solid #28a745; }
        .risk-score-medium-bg { background-color: #fff3cd; border-left: 5px solid #ffc107; }
        .risk-score-high-bg { background-color: #f8d7da; border-left: 5px solid #dc3545; }

        /* Text colors for score and label */
        .risk-score-low-text { color: #155724; } /* Dark green */
        .risk-score-medium-text { color: #856404; } /* Dark yellow/orange */
        .risk-score-high-text { color: #721c24; } /* Dark red */

        .diff-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #fdf5e6; /* A light beige or similar for diffs */
            border: 1px solid #faf0dd;
            border-radius: 4px;
        }
        .diff-section h2 {
            margin-top: 0;
            color: #5c3c00;
        }
        /* difflib's HtmlDiff table has its own styles, but you can override them here if needed */
        .diff-section table { width: 100%; border-collapse: collapse; }
        .diff-section th, .diff-section td { border: 1px solid #ccc; padding: 5px; text-align: left; vertical-align: top; font-family: monospace; }
        .diff-section .diff_header { background-color: #e0e0e0; }
        .diff-section .diff_next { background-color: #c0c0c0; }
        .diff-section .diff_add { background-color: #ddffdd; }
        .diff-section .diff_chg { background-color: #ffffcc; }
        .diff-section .diff_sub { background-color: #ffdddd; }
        .policy-text { background-color: #e9e9e9; padding: 15px; border-radius: 4px; margin-bottom: 20px; white-space: pre-wrap; font-family: monospace; max-height: 200px; overflow-y: auto; border: 1px solid #ddd;}
        .sentence-block { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; }
        .sentence-text { font-style: italic; color: #555; margin-bottom: 10px; }
        .ai-category { font-weight: bold; color: #0056b3; margin-bottom: 10px; }
        .plain-summary { color: #444; margin-bottom: 10px; background-color: #f0f0f0; padding: 8px; border-radius: 3px; }
        .concern-level-text { font-weight: bold; margin-bottom: 10px; }
        .keyword-match { margin-left: 20px; padding: 10px; border-left: 3px solid #007bff; background-color: #e7f3ff; margin-bottom: 5px; border-radius: 4px; }
        .keyword-match p { margin: 5px 0; }
        /* Concern level styling */
        .concern-high { border-left: 5px solid red !important; background-color: #ffe0e0 !important; }
        .concern-medium { border-left: 5px solid orange !important; background-color: #fff0e0 !important; }
        .concern-low { border-left: 5px solid #77cc77 !important; background-color: #e0ffe0 !important; }
        .concern-none { border-left: 5px solid #eee !important; }
        .recommendations-block {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9f5ff; /* Light blue, distinct from other blocks */
            border: 1px solid #cce4ff;
            border-radius: 4px;
        }
        .recommendations-block h4 {
            margin-top: 0;
            color: #004085; /* Darker blue for heading */
            font-size: 1.1em;
        }
        .recommendations-block ul {
            padding-left: 20px;
            margin-bottom: 0;
        }
        .recommendations-block li {
            margin-bottom: 8px;
        }
        .no-results { color: #777; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .back-link { display: inline-block; margin-top: 20px; padding: 10px 15px; background-color: #5bc0de; color: white; text-decoration: none; border-radius: 4px; }
        .back-link:hover { background-color: #46b8da; }
        .note { color: orange; margin-top: 20px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ page_title if page_title else "Analysis Results" }}</h1>

        {% if risk_assessment %}
            {% set score = risk_assessment.service_risk_score | round | int %}
            {% set score_color_class = 'risk-score-low' %}
            {% if score > 66 %}
                {% set score_color_class = 'risk-score-high' %}
            {% elif score > 33 %}
                {% set score_color_class = 'risk-score-medium' %}
            {% endif %}

            <div class="risk-summary-box {{ score_color_class }}-bg">
                <h3>Privacy Risk Assessment</h3>
                <p><strong>Calculated Risk Score:</strong>
                    <span class="risk-score-value {{ score_color_class }}-text">{{ score }}/100</span>
                </p>
                <p class="risk-category-label {{ score_color_class }}-text">
                    {% if score_color_class == 'risk-score-high' %}High Risk
                    {% elif score_color_class == 'risk-score-medium' %}Medium Risk
                    {% else %}Low Risk
                    {% endif %}
                </p>
                <hr class="risk-hr">
                <p><strong>High Concern Clauses:</strong> {{ risk_assessment.high_concern_count }}</p>
                <p><strong>Medium Concern Clauses:</strong> {{ risk_assessment.medium_concern_count }}</p>
                <p><strong>Low Concern Clauses:</strong> {{ risk_assessment.low_concern_count }}</p>
                <p><strong>Uncategorized/No Concern Clauses:</strong> {{ risk_assessment.none_concern_count }}</p>
                <p><em>(Based on {{ risk_assessment.num_clauses_analyzed }} clauses analyzed)</em></p>
            </div>
        {% endif %}

        {% if diff_html %}
        <div class="diff-section">
            <h2>Changes Since Last Analysis</h2>
            <div>{{ diff_html | safe }}</div>
        </div>
        {% endif %}

        <h2>Original Policy Text:</h2>
        <div class="policy-text">{{ policy_text if policy_text else "No text submitted." }}</div>

        <h2>Detailed Analysis:</h2>
        {% if analysis_results %}
            {% for sentence_analysis in analysis_results %}
                <div class="sentence-block concern-{{ sentence_analysis.user_concern_level | lower }}">
                    <p class="sentence-text"><strong>Sentence:</strong> {{ sentence_analysis.clause_text }}</p>
                    <p class="ai-category">AI Predicted Category: {{ sentence_analysis.ai_category }}</p>
                    <p class="plain-summary"><strong>Plain Language Summary:</strong> {{ sentence_analysis.plain_language_summary }}</p>
                    <p class="concern-level-text"><strong>Concern Level:</strong> {{ sentence_analysis.user_concern_level }}</p>

                    {% if sentence_analysis.keyword_matches %}
                        <p><strong>Keyword Matches in this sentence:</strong></p>
                        {% for match in sentence_analysis.keyword_matches %}
                            <div class="keyword-match">
                                <p><strong>Keyword:</strong> {{ match.keyword }}</p>
                                <p><strong>Original Category:</strong> {{ match.category }}</p>
                                <p><strong>Explanation:</strong> {{ match.explanation }}</p>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p><em>No specific keywords flagged in this sentence by the keyword scanner.</em></p>
                    {% endif %}

                    {% if sentence_analysis.recommendations %}
                        <div class="recommendations-block">
                            <h4>Actionable Recommendations for this clause:</h4>
                            <ul>
                                {% for rec in sentence_analysis.recommendations %}
                                    <li>
                                        <strong>{{ rec.title }}</strong>: {{ rec.text }}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p class="no-results">No analysis results to display. Input might have been empty or no clauses were processed.</p>
        {% endif %}

        {% if not nlp_available %}
            <p class="note"><strong>Note:</strong> The spaCy NLP model (en_core_web_sm) was not available when the server started. Sentence segmentation and AI categorization quality might be affected or disabled. Keyword spotting might still work based on simpler rules if implemented as a fallback in the interpreter.</p>
        {% endif %}

        <p style="text-align: center; margin-top: 30px;">
            <a href="{{ url_for('dashboard_overview') }}">Dashboard</a> |
        {% if is_historical_view %}
            <a href="{{ url_for('history_list') }}">Back to History List</a>
        {% else %}
            <a href="{{ url_for('index') }}">Analyze Another Policy</a>
        {% endif %}
        </p>
    </div>
</body>
</html>
